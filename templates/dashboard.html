<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Bin Dashboard</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .bg-secondary {
        background-color: rgb(42, 47, 51) !important;
      }
    </style>
  </head>
  <body class="bg-dark text-light">
    <!-- Mobile Bottom Navigation -->
    {% include 'nav.html' %}

    <div class="container mt-4">
      <!-- ESP8266 Status -->
      <h2>Controllers Status</h2>
      <div class="row g-3 mb-4">
        <div class="col-md-6 col-12">
          <div class="card p-2 rounded rounded-4 bg-secondary text-light">
            <div
              class="card-body d-flex align-items-center justify-content-between"
            >
              <div class="fs-1"><i class="bi bi-cpu me-2"></i> ESP8266 - 1</div>
              <span
                id="esp1-status"
                class="badge bg-danger d-flex align-items-center"
              >
                <i class="bi bi-wifi me-1"></i> Disconnected
              </span>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-12">
          <div class="card p-2 rounded rounded-4 bg-secondary text-light">
            <div
              class="card-body d-flex align-items-center justify-content-between"
            >
              <div class="fs-1"><i class="bi bi-cpu me-2"></i> ESP8266 - 2</div>
              <span
                id="esp2-status"
                class="badge bg-danger d-flex align-items-center"
              >
                <i class="bi bi-wifi-off me-1"></i> Disconnected
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bin Fill Donut Charts in 4 Columns -->
      <h2>Bin Fill Levels</h2>
      <div class="row text-center mb-5">
        <div class="col-md-3 col-6 mb-4">
          <div class="card p-3 bg-secondary rounded rounded-4">
            <div class="d-flex justify-content-between">
              <h5 class="text-light">Bin 1</h5>
              <p class="text-light"><span id="bin1">0</span> cm</p>
            </div>
            <div id="donut-bin1"></div>
          </div>
        </div>
        <div class="col-md-3 col-6 mb-4">
          <div class="card p-3 bg-secondary rounded rounded-4">
            <div class="d-flex justify-content-between">
              <h5 class="text-light">Bin 2</h5>
              <p class="text-light"><span id="bin2">0</span> cm</p>
            </div>
            <div id="donut-bin2"></div>
          </div>
        </div>
        <div class="col-md-3 col-6 mb-4">
          <div class="card p-3 bg-secondary rounded rounded-4">
            <div class="d-flex justify-content-between">
              <h5 class="text-light">Bin 3</h5>
              <p class="text-light"><span id="bin3">0</span> cm</p>
            </div>
            <div id="donut-bin3"></div>
          </div>
        </div>
        <div class="col-md-3 col-6 mb-4">
          <div class="card p-3 bg-secondary rounded rounded-4">
            <div class="d-flex justify-content-between">
              <h5 class="text-light">Bin 4</h5>
              <p class="text-light"><span id="bin4">0</span> cm</p>
            </div>
            <div id="donut-bin4"></div>
          </div>
        </div>
      </div>

      <!-- Garbage Summary -->
      <h2>Garbage Summary</h2>
      <div id="bar-chart" class="mb-5"></div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
    <script>
      // --- State ---
      let lastData = { plastic: 0, paper: 0, metal: 0, general: 0 };
      let lastUpdate = { esp8266_1: null, esp8266_2: null };
      const maxDist = 30; // empty
      const minDist = 5; // full
      let donutCharts = [];

      // --- Helpers ---
      function distanceToPercent(distance) {
        const d = Math.min(Math.max(distance, minDist), maxDist);
        return Math.round(((maxDist - d) / (maxDist - minDist)) * 100);
      }

      function renderDonut(id, value, color, index) {
        if (donutCharts[index]) {
          // Update series dynamically
          donutCharts[index].updateSeries([value]);
        } else {
          const options = {
            chart: { type: "radialBar", height: 250 },
            series: [value],
            colors: [color],
            plotOptions: {
              radialBar: {
                hollow: {
                  size: "70%",
                },
                track: {
                  background: "#6c757d", // shows the empty portion
                },
                dataLabels: {
                  name: { show: false },
                  value: {
                    show: true,
                    fontSize: "28px",
                    fontWeight: "bold",
                    color: "#fff",
                    formatter: function (val) {
                      return val + "%"; // always show filled percentage
                    },
                  },
                },
              },
            },
            stroke: { lineCap: "round" },
            labels: ["Fill"],
          };

          donutCharts[index] = new ApexCharts(
            document.querySelector(id),
            options
          );
          donutCharts[index].render();
        }
      }

      // --- Fetch Functions ---
      async function fetchBinDistances() {
        try {
          const response = await fetch(
            "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/bins.json"
          );
          const data = await response.json();
          const { bin1 = 0, bin2 = 0, bin3 = 0, bin4 = 0 } = data || {};

          // Update labels
          document.getElementById("bin1").innerText = bin1;
          document.getElementById("bin2").innerText = bin2;
          document.getElementById("bin3").innerText = bin3;
          document.getElementById("bin4").innerText = bin4;

          // Update donut charts
          const fillData = [
            distanceToPercent(bin1),
            distanceToPercent(bin2),
            distanceToPercent(bin3),
            distanceToPercent(bin4),
          ];
          renderDonut("#donut-bin1", fillData[0], "#4CAF50", 0);
          renderDonut("#donut-bin2", fillData[1], "#2196F3", 1);
          renderDonut("#donut-bin3", fillData[2], "#FFC107", 2);
          renderDonut("#donut-bin4", fillData[3], "#9C27B0", 3);
        } catch (err) {
          console.error("Error fetching bin distances:", err);
        }
      }

      async function fetchGarbageSummary() {
        try {
          const response = await fetch("/getDashboardCount");
          const rawData = await response.json();
          const { plastic = 0, paper = 0, metal = 0, general = 0 } = rawData;

          if (
            lastData.plastic !== plastic ||
            lastData.paper !== paper ||
            lastData.metal !== metal ||
            lastData.general !== general
          ) {
            lastData = { plastic, paper, metal, general };
            const seriesData = [plastic, paper, metal, general];
            const chart = ApexCharts.getChartByID("bar-chart");

            if (chart) {
              chart.updateSeries([{ name: "Count", data: seriesData }], false);
            } else {
              const options = {
                chart: { type: "bar", height: 300, id: "bar-chart" },
                series: [{ name: "Count", data: seriesData }],
                xaxis: { categories: ["Plastic", "Paper", "Metal", "general"] },
                colors: ["#4CAF50", "#2196F3", "#FFC107", "#9C27B0"],
                dataLabels: { enabled: true },
              };
              new ApexCharts(
                document.querySelector("#bar-chart"),
                options
              ).render();
            }
          }
        } catch (err) {
          console.error("Error fetching garbage summary:", err);
        }
      }

      async function fetchESPStatus() {
        try {
          const response = await fetch(
            "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/devices.json"
          );
          const data = await response.json();

          const esp1Last = data.esp8266_1?.last_update || 0;
          const esp2Last = data.esp8266_2?.last_update || 0;

          const esp1Connected =
            lastUpdate.esp8266_1 !== null && esp1Last !== lastUpdate.esp8266_1;
          const esp2Connected =
            lastUpdate.esp8266_2 !== null && esp2Last !== lastUpdate.esp8266_2;

          const esp1Badge = document.getElementById("esp1-status");
          const esp2Badge = document.getElementById("esp2-status");

          esp1Badge.className = esp1Connected
            ? "badge bg-success d-flex align-items-center"
            : "badge bg-danger d-flex align-items-center";
          esp1Badge.innerHTML = esp1Connected
            ? '<i class="bi bi-wifi me-1"></i> Connected'
            : '<i class="bi bi-wifi-off me-1"></i> Disconnected';

          esp2Badge.className = esp2Connected
            ? "badge bg-success d-flex align-items-center"
            : "badge bg-danger d-flex align-items-center";
          esp2Badge.innerHTML = esp2Connected
            ? '<i class="bi bi-wifi me-1"></i> Connected'
            : '<i class="bi bi-wifi-off me-1"></i> Disconnected';

          lastUpdate.esp8266_1 = esp1Last;
          lastUpdate.esp8266_2 = esp2Last;
        } catch (err) {
          console.error("Error fetching ESP status:", err);
        }
      }

      // --- Intervals ---
      setInterval(fetchBinDistances, 2000); // every 2s
      setInterval(fetchGarbageSummary, 5000); // every 5s
      setInterval(fetchESPStatus, 5000); // every 5s

      // --- Initial Fetch ---
      fetchBinDistances();
      fetchGarbageSummary();
      fetchESPStatus();
    </script>
  </body>
</html>
