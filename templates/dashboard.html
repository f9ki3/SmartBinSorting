<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Bin Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-dark">
    <!-- Mobile Bottom Navigation -->
    {% include 'nav.html' %}

    <div class="container mt-4">
      <!-- ESP8266 Status -->
      <div class="row">
        <div class="col-12">
          <h2 class="text-light">ESP8266 Status</h2>
          <ul class="list-group list-group-flush text-light">
            <li class="list-group-item text-light bg-dark">
              ESP8266 #1: <span id="esp1-status">Offline</span>
            </li>
            <li class="list-group-item text-light bg-dark">
              ESP8266 #2: <span id="esp2-status">Offline</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- Bin Distances -->
      <div class="row mt-4">
        <div class="col-12">
          <h2 class="text-light">Bin Distances (cm)</h2>
          <ul class="list-group list-group-flush text-light">
            <li class="list-group-item text-light bg-dark">
              Bin 1: <span id="bin1">0</span> cm
            </li>
            <li class="list-group-item text-light bg-dark">
              Bin 2: <span id="bin2">0</span> cm
            </li>
            <li class="list-group-item text-light bg-dark">
              Bin 3: <span id="bin3">0</span> cm
            </li>
            <li class="list-group-item text-light bg-dark">
              Bin 4: <span id="bin4">0</span> cm
            </li>
          </ul>
        </div>
      </div>

      <!-- Garbage Summary -->
      <div class="row mt-4 mb-5">
        <div class="col-12">
          <h2 class="text-light">Garbage Summary</h2>
          <div id="bar-chart"></div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>

    <script>
      // Last known data for garbage summary
      let lastData = { plastic: 0, paper: 0, metal: 0, waste: 0 };

      // Fetch bin distances
      async function fetchBinDistances() {
        try {
          const response = await fetch(
            "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/bins.json"
          );
          const data = await response.json();
          const { bin1 = 0, bin2 = 0, bin3 = 0, bin4 = 0 } = data || {};

          document.getElementById("bin1").innerText = bin1;
          document.getElementById("bin2").innerText = bin2;
          document.getElementById("bin3").innerText = bin3;
          document.getElementById("bin4").innerText = bin4;
        } catch (error) {
          console.error("Error fetching bin distances:", error);
        }
      }

      // Fetch garbage summary for bar chart
      async function fetchGarbageSummary() {
        try {
          const response = await fetch("/getDashboardCount");
          const rawData = await response.json();
          const { plastic = 0, paper = 0, metal = 0, waste = 0 } = rawData;

          if (
            lastData.plastic !== plastic ||
            lastData.paper !== paper ||
            lastData.metal !== metal ||
            lastData.waste !== waste
          ) {
            lastData = { plastic, paper, metal, waste };

            const chart = ApexCharts.getChartByID("bar-chart");
            const seriesData = [plastic, paper, metal, waste];
            if (chart) {
              chart.updateSeries([{ name: "Count", data: seriesData }], false);
            } else {
              const options = {
                chart: { type: "bar", height: 300, id: "bar-chart" },
                series: [{ name: "Count", data: seriesData }],
                xaxis: { categories: ["Plastic", "Paper", "Metal", "Waste"] },
                colors: ["#4CAF50", "#2196F3", "#FFC107", "#9C27B0"],
                dataLabels: { enabled: true },
              };
              new ApexCharts(
                document.querySelector("#bar-chart"),
                options
              ).render();
            }
          }
        } catch (error) {
          console.error("Error fetching garbage summary:", error);
        }
      }

      // Fetch ESP8266 connection status
      async function fetchESPStatus() {
        try {
          const response = await fetch(
            "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/devices.json"
          );
          const data = await response.json();

          const esp1 = data.esp8266_1 || { status: "offline" };
          const esp2 = data.esp8266_2 || { status: "offline" };

          const esp1Status =
            esp1.status === "online" ? "Online ðŸŸ¢" : "Offline ðŸ”´";
          const esp2Status =
            esp2.status === "online" ? "Online ðŸŸ¢" : "Offline ðŸ”´";

          document.getElementById("esp1-status").innerText = esp1Status;
          document.getElementById("esp2-status").innerText = esp2Status;
        } catch (error) {
          console.error("Error fetching ESP status:", error);
        }
      }

      // Update everything every 5 seconds
      setInterval(() => {
        fetchBinDistances();
        fetchGarbageSummary();
        fetchESPStatus();
      }, 5000);

      // Initial fetch
      fetchBinDistances();
      fetchGarbageSummary();
      fetchESPStatus();
    </script>
  </body>
</html>
