<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Bin Dashboard</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
      .bg-secondary {
        background-color: rgb(42, 47, 51) !important;
      }
      .card {
        border-radius: 1rem;
      }
    </style>
  </head>
  <body class="bg-dark text-light">
    <div class="container mt-4">
      <!-- ESP8266 Status -->
      <h2>Controllers Status</h2>
      <div class="row g-3 mb-4">
        <div class="col-md-6 col-12">
          <div class="card p-2 bg-secondary text-light">
            <div
              class="card-body d-flex align-items-center justify-content-between"
            >
              <div class="fs-5"><i class="bi bi-cpu me-2"></i>ESP8266 - 1</div>
              <span
                id="esp1-status"
                class="badge bg-danger d-flex align-items-center"
              >
                <i class="bi bi-wifi-off me-1"></i> Disconnected
              </span>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-12">
          <div class="card p-2 bg-secondary text-light">
            <div
              class="card-body d-flex align-items-center justify-content-between"
            >
              <div class="fs-5"><i class="bi bi-cpu me-2"></i>ESP8266 - 2</div>
              <span
                id="esp2-status"
                class="badge bg-danger d-flex align-items-center"
              >
                <i class="bi bi-wifi-off me-1"></i> Disconnected
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bin Distances -->
      <h2>Bin Distances (cm)</h2>
      <ul class="list-group list-group-flush text-light mb-4">
        <li class="list-group-item text-light bg-dark">
          Bin 1: <span id="bin1">0</span> cm
        </li>
        <li class="list-group-item text-light bg-dark">
          Bin 2: <span id="bin2">0</span> cm
        </li>
        <li class="list-group-item text-light bg-dark">
          Bin 3: <span id="bin3">0</span> cm
        </li>
        <li class="list-group-item text-light bg-dark">
          Bin 4: <span id="bin4">0</span> cm
        </li>
      </ul>

      <!-- Bin Fill Donut Charts in 4 Columns -->
      <h2>Bin Fill Levels</h2>
      <div class="row text-center mb-5">
        <div class="col-md-3 col-6 mb-4">
          <h5>Bin 1</h5>
          <div id="donut-bin1"></div>
        </div>
        <div class="col-md-3 col-6 mb-4">
          <h5>Bin 2</h5>
          <div id="donut-bin2"></div>
        </div>
        <div class="col-md-3 col-6 mb-4">
          <h5>Bin 3</h5>
          <div id="donut-bin3"></div>
        </div>
        <div class="col-md-3 col-6 mb-4">
          <h5>Bin 4</h5>
          <div id="donut-bin4"></div>
        </div>
      </div>
    </div>

    <script>
      const maxDist = 30; // empty
      const minDist = 5; // full
      let charts = [];

      // Track last update for ESP to detect connection
      let lastUpdate = { esp8266_1: null, esp8266_2: null };

      // Convert distance to fill percentage
      function distanceToPercent(distance) {
        const d = Math.min(Math.max(distance, minDist), maxDist);
        return Math.round(((maxDist - d) / (maxDist - minDist)) * 100);
      }

      // Render or update donut chart
      function renderDonut(id, value, color, index) {
        if (charts[index]) {
          charts[index].updateSeries([value, 100 - value]);
        } else {
          const options = {
            chart: { type: "donut", height: 250 },
            series: [value, 100 - value],
            labels: ["Full", "Empty"],
            colors: [color, "#6c757d"],
            dataLabels: { enabled: true, formatter: (val) => val + "%" },
            legend: { show: false },
            plotOptions: {
              pie: {
                donut: {
                  size: "70%",
                  labels: {
                    show: true,
                    name: { show: false },
                    value: {
                      show: true,
                      fontSize: "20px",
                      color: "#fff",
                      formatter: (val) => val + "%",
                    },
                  },
                },
              },
            },
          };
          charts[index] = new ApexCharts(document.querySelector(id), options);
          charts[index].render();
        }
      }

      // Fetch bin distances and update donuts
      async function fetchBinDistances() {
        try {
          const response = await fetch(
            "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/bins.json"
          );
          const data = await response.json();
          const { bin1 = 0, bin2 = 0, bin3 = 0, bin4 = 0 } = data || {};

          document.getElementById("bin1").innerText = bin1;
          document.getElementById("bin2").innerText = bin2;
          document.getElementById("bin3").innerText = bin3;
          document.getElementById("bin4").innerText = bin4;

          const fillData = [
            distanceToPercent(bin1),
            distanceToPercent(bin2),
            distanceToPercent(bin3),
            distanceToPercent(bin4),
          ];

          renderDonut("#donut-bin1", fillData[0], "#4CAF50", 0);
          renderDonut("#donut-bin2", fillData[1], "#2196F3", 1);
          renderDonut("#donut-bin3", fillData[2], "#FFC107", 2);
          renderDonut("#donut-bin4", fillData[3], "#9C27B0", 3);
        } catch (err) {
          console.error("Error fetching bin distances:", err);
        }
      }

      // Fetch ESP8266 status separately
      async function fetchESPStatus() {
        try {
          const response = await fetch(
            "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/devices.json"
          );
          const data = await response.json();

          const esp1Last = data.esp8266_1?.last_update || 0;
          const esp2Last = data.esp8266_2?.last_update || 0;

          const esp1Connected =
            lastUpdate.esp8266_1 !== null && esp1Last !== lastUpdate.esp8266_1;
          const esp2Connected =
            lastUpdate.esp8266_2 !== null && esp2Last !== lastUpdate.esp8266_2;

          const esp1Badge = document.getElementById("esp1-status");
          const esp2Badge = document.getElementById("esp2-status");

          esp1Badge.className = esp1Connected
            ? "badge bg-success d-flex align-items-center"
            : "badge bg-danger d-flex align-items-center";
          esp1Badge.innerHTML = esp1Connected
            ? '<i class="bi bi-wifi me-1"></i> Connected'
            : '<i class="bi bi-wifi-off me-1"></i> Disconnected';

          esp2Badge.className = esp2Connected
            ? "badge bg-success d-flex align-items-center"
            : "badge bg-danger d-flex align-items-center";
          esp2Badge.innerHTML = esp2Connected
            ? '<i class="bi bi-wifi me-1"></i> Connected'
            : '<i class="bi bi-wifi-off me-1"></i> Disconnected';

          lastUpdate.esp8266_1 = esp1Last;
          lastUpdate.esp8266_2 = esp2Last;
        } catch (err) {
          console.error("Error fetching ESP status:", err);
        }
      }

      // Separate intervals for bin distances and ESP status
      setInterval(fetchBinDistances, 2000); // update every 5s
      setInterval(fetchESPStatus, 5000); // update every 3s

      // Initial fetch
      fetchBinDistances();
      fetchESPStatus();
    </script>
  </body>
</html>
