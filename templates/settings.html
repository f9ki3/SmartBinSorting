<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Bin Dashboard</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .bg-secondary {
        background-color: rgb(42, 47, 51) !important;
      }
    </style>
  </head>
  <body class="bg-dark text-light">
    <!-- Mobile Bottom Navigation -->
    {% include 'nav.html' %}

    <div class="container">
      <h1 class="text-center mt-4">Settings</h1>
      <div class="row">
        <div class="col-12 col-md-3"></div>

        <div class="col-12 col-md-6">
          <div class="card mb-5 bg-secondary text-light rounded-4 p-4">
            <!-- Title -->
            <h5 class="mb-4 fw-bolder">Configuration</h5>

            <!-- SMS Alert Switch -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <label class="mb-0" for="smsAlertSwitch">SMS Alerts</label>
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="smsAlertSwitch"
                />
              </div>
            </div>

            <!-- System Alert Switch -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <label class="mb-0" for="systemAlertSwitch">System Alerts</label>
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="systemAlertSwitch"
                />
              </div>
            </div>

            <script>
              const firebaseUrl =
                "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/settings.json";

              // Function to fetch current settings from Firebase
              function fetchSettings() {
                fetch(firebaseUrl)
                  .then((res) => res.json())
                  .then((data) => {
                    if (data) {
                      smsSwitch.checked = !!data["sms-notification"];
                      systemSwitch.checked = !!data["system-notification"];
                    }
                  })
                  .catch((err) =>
                    console.error("Error fetching settings:", err)
                  );
              }

              // Function to update a setting in Firebase
              function updateSetting(key, value) {
                const payload = {};
                payload[key] = value;

                fetch(firebaseUrl, {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                })
                  .then((res) => res.json())
                  .then((data) => console.log(`Updated ${key} to`, value, data))
                  .catch((err) =>
                    console.error("Error updating Firebase:", err)
                  );
              }

              // Get switch elements
              const smsSwitch = document.getElementById("smsAlertSwitch");
              const systemSwitch = document.getElementById("systemAlertSwitch");

              // Load initial settings from Firebase
              fetchSettings();

              // Update Firebase when switches change
              smsSwitch.addEventListener("change", () => {
                updateSetting("sms-notification", smsSwitch.checked);
              });

              systemSwitch.addEventListener("change", () => {
                updateSetting("system-notification", systemSwitch.checked);
              });
            </script>

            <hr class="border-light my-4" />

            <!-- Change Pincode Section -->
            <h5 class="mb-4 fw-bolder">Change Pincode</h5>

            <!-- Current Pincode -->
            <form id="pinForm">
              <!-- Current Pincode -->
              <div class="mb-3">
                <label class="form-label" for="currentPin"
                  >Current Pincode</label
                >
                <div class="input-group">
                  <input
                    type="password"
                    id="currentPin"
                    class="form-control"
                    maxlength="6"
                    placeholder="Enter current pincode"
                  />
                  <span class="input-group-text">
                    <i
                      class="bi bi-eye-slash"
                      id="toggleCurrent"
                      style="cursor: pointer"
                    ></i>
                  </span>
                </div>
                <div class="custom-error" id="currentError"></div>
              </div>

              <!-- New Pincode -->
              <div class="mb-3">
                <label class="form-label" for="newPin">New Pincode</label>
                <div class="input-group">
                  <input
                    type="password"
                    id="newPin"
                    class="form-control"
                    maxlength="6"
                    placeholder="Enter new pincode"
                  />
                  <span class="input-group-text">
                    <i
                      class="bi bi-eye-slash"
                      id="toggleNew"
                      style="cursor: pointer"
                    ></i>
                  </span>
                </div>
                <div class="custom-error" id="newError"></div>
              </div>

              <!-- Confirm Pincode -->
              <div class="mb-4">
                <label class="form-label" for="confirmPin"
                  >Confirm Pincode</label
                >
                <div class="input-group">
                  <input
                    type="password"
                    id="confirmPin"
                    class="form-control"
                    maxlength="6"
                    placeholder="Confirm new pincode"
                  />
                  <span class="input-group-text">
                    <i
                      class="bi bi-eye-slash"
                      id="toggleConfirm"
                      style="cursor: pointer"
                    ></i>
                  </span>
                </div>
                <div class="custom-error" id="confirmError"></div>
              </div>

              <!-- Save Button -->
              <div class="w-100 gap-2 justify-content-center">
                <!-- Save Button -->
                <button
                  type="submit"
                  id="saveBtn"
                  class="btn mb-3 w-100 btn-success"
                >
                  Save
                </button>

                <!-- Logout Button -->
                <a
                  href="/logout"
                  id="logoutBtn"
                  class="btn mb-3 w-100 btn-danger text-center"
                >
                  Logout
                </a>
              </div>
            </form>

            <style>
              .custom-error {
                color: red;
                font-size: 0.875rem;
                margin-top: 4px;
              }
              .input-error {
                border-color: red !important;
              }
            </style>

            <script>
              // Allow only digits
              ["currentPin", "newPin", "confirmPin"].forEach((id) => {
                const input = document.getElementById(id);
                input.addEventListener("input", () => {
                  input.value = input.value.replace(/\D/g, "");
                  input.classList.remove("input-error");
                  document.getElementById(id + "Error").innerText = "";
                });
              });

              // Toggle password visibility
              function togglePassword(inputId, iconId) {
                const input = document.getElementById(inputId);
                const icon = document.getElementById(iconId);
                if (!input || !icon) return;

                const isPassword = input.type === "password";
                input.type = isPassword ? "text" : "password";

                icon.classList.toggle("bi-eye-slash", isPassword);
                icon.classList.toggle("bi-eye", !isPassword);
              }

              ["toggleCurrent", "toggleNew", "toggleConfirm"].forEach(
                (iconId, idx) => {
                  const inputId = ["currentPin", "newPin", "confirmPin"][idx];
                  document
                    .getElementById(iconId)
                    .addEventListener("click", () =>
                      togglePassword(inputId, iconId)
                    );
                }
              );

              // Validation and update on submit
              document
                .getElementById("pinForm")
                .addEventListener("submit", async (e) => {
                  e.preventDefault();

                  const currentInput = document.getElementById("currentPin");
                  const newInput = document.getElementById("newPin");
                  const confirmInput = document.getElementById("confirmPin");

                  const current = currentInput.value;
                  const newPin = newInput.value;
                  const confirm = confirmInput.value;

                  // Clear previous errors
                  ["currentError", "newError", "confirmError"].forEach((id) => {
                    document.getElementById(id).innerText = "";
                  });
                  [currentInput, newInput, confirmInput].forEach((input) => {
                    input.classList.remove("input-error");
                  });

                  let valid = true;

                  // Fetch current pincode from Firebase
                  let correctCurrent = "";
                  try {
                    const response = await fetch(
                      "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/settings.json"
                    );
                    const data = await response.json();
                    correctCurrent = data.password || "";
                  } catch (err) {
                    console.error("Error fetching current pincode:", err);
                    document.getElementById("currentError").innerText =
                      "Unable to fetch current pincode. Try again later.";
                    currentInput.classList.add("input-error");
                    valid = false;
                  }

                  // Current pincode validation
                  if (current.length !== 6) {
                    document.getElementById("currentError").innerText =
                      "Current pincode must be 6 digits.";
                    currentInput.classList.add("input-error");
                    valid = false;
                  } else if (current !== correctCurrent) {
                    document.getElementById("currentError").innerText =
                      "Current pincode is incorrect.";
                    currentInput.classList.add("input-error");
                    valid = false;
                  }

                  // New pincode validation
                  if (newPin.length !== 6) {
                    document.getElementById("newError").innerText =
                      "New pincode must be 6 digits.";
                    newInput.classList.add("input-error");
                    valid = false;
                  }

                  // Confirm pincode validation
                  if (confirm.length !== 6) {
                    document.getElementById("confirmError").innerText =
                      "Confirm pincode must be 6 digits.";
                    confirmInput.classList.add("input-error");
                    valid = false;
                  } else if (newPin !== confirm) {
                    document.getElementById("confirmError").innerText =
                      "New and confirm pincode do not match.";
                    confirmInput.classList.add("input-error");
                    valid = false;
                  }

                  // Update Firebase if valid
                  if (valid) {
                    try {
                      const updateResponse = await fetch(
                        "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/settings.json",
                        {
                          method: "PATCH",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify({ password: newPin }),
                        }
                      );

                      if (updateResponse.ok) {
                        alert("Pincode updated successfully!");
                        currentInput.value = "";
                        newInput.value = "";
                        confirmInput.value = "";
                      } else {
                        alert("Failed to update pincode. Try again.");
                      }
                    } catch (err) {
                      console.error("Error updating pincode:", err);
                      alert("Error updating pincode. Check console.");
                    }
                  }
                });
            </script>
          </div>
        </div>

        <!-- CSS to change active switch color to green -->
        <style>
          /* Bootstrap 5 switch active color override */
          .form-check-input:checked {
            background-color: #28a745 !important; /* green */
            border-color: #28a745 !important;
          }

          .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25); /* green shadow */
          }
        </style>

        <div class="col-12 col-md-3"></div>
      </div>
    </div>
  </body>
</html>
