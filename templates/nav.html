<div class="sticky-top d-none d-md-block">
  <div class="p-3" style="background-color: #198754">
    <div
      class="container d-flex flex-column flex-md-row align-items-center justify-content-between"
    >
      <h3 class="text-light fw-bolder mb-2 mb-md-0">Smart Waste Management</h3>
      <div class="d-flex flex-column flex-md-row gap-3">
        <a
          class="text-decoration-none text-light d-flex align-items-center gap-2"
          href="/home"
        >
          <i class="bi bi-qr-code-scan"></i>
          Scan Trash
        </a>
        <a
          class="text-decoration-none text-light d-flex align-items-center gap-2"
          href="/dashboard"
        >
          <i class="bi bi-speedometer2"></i>
          Dashboard
        </a>
        <a
          class="text-decoration-none text-light d-flex align-items-center gap-2"
          href="/settings"
        >
          <i class="bi bi-gear"></i>
          Settings
        </a>
        <a
          class="text-decoration-none text-light d-flex align-items-center gap-2 bell-icon position-relative"
          data-bs-toggle="offcanvas"
          data-bs-target="#staticBackdrop"
          aria-controls="staticBackdrop"
          style="cursor: pointer"
        >
          <i class="bi bi-bell-fill"></i>
          Notification
          <span
            class="notif-counter"
            style="
              position: absolute;
              top: -15px;
              right: 78px;
              font-size: 0.7rem;
              background: red;
              color: white;
              border-radius: 50%;
              padding: 2px 6px;
              display: none;
            "
            >0</span
          >
        </a>
        <a
          class="text-decoration-none text-light d-flex align-items-center gap-2"
          href="/logout"
        >
          <i class="bi bi-box-arrow-right"></i>
          Logout
        </a>
      </div>
    </div>
  </div>
</div>
<nav class="d-md-none custom-shadow navbar fixed-bottom bg-dark text-light">
  <div class="container d-flex justify-content-around">
    <!-- Scan Button -->
    <a
      class="text-decoration-none text-light d-flex flex-column text-center bell-icon position-relative"
      data-bs-toggle="offcanvas"
      data-bs-target="#staticBackdrop"
      aria-controls="staticBackdrop"
      style="cursor: pointer"
    >
      <i class="bi bi-bell" style="font-size: 1.5rem"></i>
      <span style="font-size: 0.8rem">Notification</span>
      <span
        class="notif-counter"
        style="
          position: absolute;
          top: 0;
          right: 0;
          font-size: 0.7rem;
          background: red;
          color: white;
          border-radius: 50%;
          padding: 2px 6px;
          display: none;
        "
        >0</span
      >
    </a>

    <!-- Dashboard Button -->
    <a
      href="/dashboard"
      class="text-light text-decoration-none d-flex flex-column text-center flex-column"
    >
      <i class="bi bi-speedometer2" style="font-size: 1.5rem"></i>
      <span style="font-size: 0.8rem">Dashboard</span>
    </a>
    <a
      href="/settings"
      class="text-light text-decoration-none d-flex flex-column text-center flex-column"
    >
      <i class="bi bi-gear" style="font-size: 1.5rem"></i>
      <span style="font-size: 0.8rem">Settings</span>
    </a>
  </div>
</nav>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
/>
<script
  src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
  integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
  crossorigin="anonymous"
></script>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
  integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
  crossorigin="anonymous"
></script>
<div
  class="offcanvas bg-dark offcanvas-start"
  data-bs-backdrop="static"
  tabindex="-1"
  id="staticBackdrop"
  aria-labelledby="staticBackdropLabel"
>
  <div class="offcanvas-header">
    <h5 class="offcanvas-title text-light" id="staticBackdropLabel">
      Notification
    </h5>
    <button
      type="button"
      class="btn-close btn-close-white"
      data-bs-dismiss="offcanvas"
      aria-label="Close"
    ></button>
  </div>

  <div
    class="offcanvas-body"
    id="notification-container"
    style="overflow-y: auto; max-height: 100vh"
  ></div>

  <div id="loading-spinner" class="text-center my-2" style="display: none">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<script>
  const container = document.getElementById("notification-container");
  const spinner = document.getElementById("loading-spinner");

  let loadedCount = 0;
  const BATCH_SIZE = 10;
  let allLoaded = false;

  async function loadNotifications() {
    if (allLoaded) return;

    spinner.style.display = "block";
    try {
      const response = await fetch(
        `/get_notifications?start=${loadedCount}&limit=${BATCH_SIZE}`
      );
      const data = await response.json();

      if (!data.length) {
        allLoaded = true; // No more notifications
        spinner.style.display = "none";
        return;
      }

      data.forEach((notif) => {
        const notifDiv = document.createElement("div");
        notifDiv.className =
          "d-flex align-items-start mb-3 p-2 bg-secondary rounded-3";
        notifDiv.innerHTML = `
          <i class="bi bi-bell-fill text-light me-3" style="font-size: 1.5rem"></i>
          <div>
            <small class="text-light">${notif.timestamp}</small>
            <p class="text-light mb-0">${notif.message}</p>
          </div>
        `;
        container.appendChild(notifDiv);
      });

      loadedCount += data.length;
    } catch (error) {
      console.error("Failed to load notifications:", error);
    } finally {
      spinner.style.display = "none";
    }
  }

  // Detect scroll to bottom
  container.addEventListener("scroll", () => {
    if (
      container.scrollTop + container.clientHeight >=
      container.scrollHeight - 10
    ) {
      loadNotifications();
    }
  });

  // Initial load
  loadNotifications();
</script>

<script>
  const FIREBASE_SETTINGS_URL =
    "https://smart-bin-1b802-default-rtdb.asia-southeast1.firebasedatabase.app/settings.json";

  // Update notification counter
  async function updateNotificationCounter() {
    try {
      const response = await fetch(FIREBASE_SETTINGS_URL);
      const data = await response.json();
      const count = data.notification || 0;

      document.querySelectorAll(".notif-counter").forEach((span) => {
        span.textContent = count;
        if (count > 0) {
          span.style.display = "inline-block";
        } else {
          span.style.display = "none";
        }
      });
    } catch (err) {
      console.error("Failed to fetch notification count", err);
    }
  }

  // Reset notification counter
  async function resetNotificationCounter() {
    try {
      await fetch(FIREBASE_SETTINGS_URL, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ notification: 0 }),
      });

      document.querySelectorAll(".notif-counter").forEach((span) => {
        span.textContent = 0;
        span.style.display = "none";
      });
    } catch (err) {
      console.error("Failed to reset notification count", err);
    }
  }

  // Attach click events to all bell icons
  document.querySelectorAll(".bell-icon").forEach((bell) => {
    bell.addEventListener("click", resetNotificationCounter);
  });

  // Poll every 3 seconds
  setInterval(updateNotificationCounter, 5000);

  // Initial load
  updateNotificationCounter();

  document.addEventListener("DOMContentLoaded", () => {
    // Select ALL <a> tags that open the same offcanvas
    const notifLinks = document.querySelectorAll(
      'a[data-bs-target="#staticBackdrop"]'
    );

    notifLinks.forEach((link) => {
      link.addEventListener("click", () => {
        loadNotifications();
      });
    });

    // Optional: also reload when the offcanvas actually opens
    const offcanvasEl = document.getElementById("staticBackdrop");
    if (offcanvasEl) {
      offcanvasEl.addEventListener("shown.bs.offcanvas", () => {
        loadNotifications();
      });
    }
  });
</script>
